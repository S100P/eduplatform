server:
  port: 8018

spring:
  application:
    name: api-gateway

  cloud:
    gateway:
      routes:
        # ====== AUTH ROUTES (публичные) ======
        - id: auth-register
          uri: http://localhost:8012
          predicates:
            - Path=/api/v1/auth/register
          filters:
            - RewritePath=/api/v1/auth/register, /api/v1/auth/register

        - id: auth-login
          uri: http://localhost:8012
          predicates:
            - Path=/api/v1/auth/login
          filters:
            - RewritePath=/api/v1/auth/login, /api/v1/auth/login
            
        - id: jwks
          uri: http://localhost:8012
          predicates:
            - Path=/.well-known/jwks.json
          filters:
            - RewritePath=/.well-known/jwks.json, /.well-known/jwks.json

        # ====== USER SERVICE ROUTES (защищенные) ======
        - id: user-service
          uri: http://localhost:8012
          predicates:
            - Path=/api/v1/users/**
          filters:
            # Проверяем JWT и добавляем заголовки
            - JwtAuthentication
            # Переписываем путь для внутреннего API
            - RewritePath=/api/v1/users/(?<segment>.*), /internal/users/${segment}
            # Добавляем внутренние заголовки
            - AddRequestHeader=X-Service-Name, api-gateway
            - AddRequestHeader=X-Request-Id, ${random.value}

        # ====== COURSE SERVICE ROUTES ======
        - id: course-service-public
          uri: http://localhost:8013
          predicates:
            - Path=/api/v1/courses/public/**
          filters:
            - RewritePath=/api/v1/courses/public/(?<segment>.*), /internal/courses/public/${segment}

        - id: course-service-protected
          uri: http://localhost:8013
          predicates:
            - Path=/api/v1/courses/**
          filters:
            - JwtAuthentication
            - RewritePath=/api/v1/courses/(?<segment>.*), /internal/courses/${segment}
            # Фильтр для проверки роли INSTRUCTOR при создании курса
#            - name: Authentication
#              args:
#                requiredRoles:
#                  - ROLE_INSTRUCTOR
#                  - ROLE_ADMIN

        # ====== ENROLLMENT SERVICE ROUTES ======
        - id: enrollment-service
          uri: http://localhost:8014
          predicates:
            - Path=/api/v1/enrollments/**
          filters:
            - JwtAuthentication
            - RewritePath=/api/v1/enrollments/(?<segment>.*), /internal/enrollments/${segment}
            # Только студенты могут записываться на курсы
#            - name: Authentication
#              args:
#                requiredRoles:
#                  - ROLE_STUDENT

        # ====== PAYMENT SERVICE ROUTES ======
        - id: payment-service
          uri: http://localhost:8015
          predicates:
            - Path=/api/v1/payments/**
          filters:
            - JwtAuthentication
            - RewritePath=/api/v1/payments/(?<segment>.*), /internal/payments/${segment}

      # Глобальные фильтры
      global-filters:
        - name: GlobalLogging
          args:
            baseMessage: 'Global Filter'
            preLogger: true
            postLogger: true

# JWT конфигурация
jwt:
  # Адрес, по которому можно получить публичные ключи для проверки JWT.
  jwks-uri: http://localhost:8012/.well-known/jwks.json
  # Секрет для внутреннего HMAC-шифрования заголовков.
  internal-secret: ${INTERNAL_SECRET:anotherStrongSecretKeyForInternalCommunication0987654321}

# Настройки безопасности
#security:
#  # IP адреса, которым разрешены внутренние вызовы
#  internal-ips:
#    - 127.0.0.1
#    - 10.0.0.0/8
#    - 172.16.0.0/12
#    - 192.168.0.0/16

# Rate Limiting
rate-limiter:
  enabled: true
  default-replenish-rate: 10
  default-burst-capacity: 20
  # Специфичные лимиты для endpoints
  endpoints:
    - path: /api/v1/auth/login
      replenish-rate: 5
      burst-capacity: 10
    - path: /api/v1/payments/**
      replenish-rate: 5
      burst-capacity: 5
    - path: /api/v1/refresh
      replenish-rate: 5
      burst-capacity: 5
