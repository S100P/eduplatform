<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>–ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏: API Gateway –∏ –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å—ã</title>
  <style>
    :root {
      --bg: #0b1020;
      --card: #101632;
      --text: #e8ecff;
      --muted: #a7b0d6;
      --accent: #7aa2ff;
      --border: #223059;
    }
    .light {
      --bg: #f7f8ff;
      --card: #ffffff;
      --text: #0c1535;
      --muted: #516089;
      --accent: #3857ff;
      --border: #e7ebff;
    }
    html, body { height: 100%; }
    body {
      margin: 0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      background: linear-gradient(180deg, var(--bg), #060a18 60%);
      color: var(--text);
    }
    header {
      position: sticky;
      top: 0;
      z-index: 10;
      backdrop-filter: blur(8px);
      background: color-mix(in oklab, var(--bg) 85%, transparent);
      border-bottom: 1px solid var(--border);
      padding: 12px 16px;
      display: flex;
      align-items: center;
      gap: 12px;
    }
    h1 { font-size: 20px; margin: 0; }
    main {
      max-width: 1080px;
      margin: 24px auto;
      padding: 0 16px 64px;
      display: grid;
      grid-template-columns: 280px 1fr;
      gap: 16px;
    }
    nav {
      position: sticky; top: 64px;
      align-self: start;
      border: 1px solid var(--border);
      background: var(--card);
      border-radius: 16px;
      padding: 12px;
    }
    nav a {
      display: block;
      padding: 8px 10px;
      margin: 2px 0;
      color: var(--text);
      text-decoration: none;
      border-radius: 10px;
    }
    nav a:hover { background: color-mix(in oklab, var(--card) 80%, var(--accent)); }
    section {
      border: 1px solid var(--border);
      background: var(--card);
      border-radius: 16px;
      padding: 16px 16px 8px;
      margin-bottom: 16px;
    }
    h2 { margin-top: 0; }
    details {
      border: 1px dashed var(--border);
      border-radius: 12px;
      padding: 12px 12px;
      margin: 8px 0 16px;
      background: color-mix(in oklab, var(--card) 90%, #000);
    }
    details[open] {
      background: color-mix(in oklab, var(--card) 80%, #000);
    }
    summary {
      cursor: pointer;
      font-weight: 600;
      color: var(--accent);
      list-style: none;
    }
    summary::-webkit-details-marker { display: none; }
    
    /* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–∏–∞–≥—Ä–∞–º–º—ã —Å –∫–Ω–æ–ø–∫–æ–π –æ—Ç–∫—Ä—ã—Ç–∏—è */
    .diagram-container {
      position: relative;
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 8px;
      background: #fff;
      color: #000;
      overflow: hidden;
      max-height: 400px;
      cursor: pointer;
    }
    .diagram-container:hover {
      border-color: var(--accent);
    }
    .diagram-expand-hint {
      position: absolute;
      top: 8px;
      right: 8px;
      background: var(--accent);
      color: white;
      padding: 4px 12px;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 600;
      pointer-events: none;
      opacity: 0.8;
      z-index: 5;
    }
    .mermaid {
      pointer-events: none;
    }
    
    /* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.9);
      z-index: 1000;
      overflow: auto;
    }
    .modal.active {
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .modal-content {
      background: white;
      border-radius: 16px;
      padding: 20px;
      max-width: 95vw;
      max-height: 95vh;
      overflow: auto;
      position: relative;
    }
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
      padding-bottom: 12px;
      border-bottom: 2px solid #eee;
    }
    .modal-title {
      font-size: 18px;
      font-weight: 600;
      color: #333;
    }
    .modal-close {
      cursor: pointer;
      background: #f5f5f5;
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 8px 16px;
      font-weight: 600;
      color: #333;
    }
    .modal-close:hover {
      background: #e0e0e0;
    }
    
    /* –ó—É–º-–∫–æ–Ω—Ç—Ä–æ–ª—ã –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ */
    .modal-zoom-controls {
      display: flex;
      gap: 8px;
      margin-bottom: 16px;
      justify-content: center;
    }
    .modal-zoom-controls button {
      padding: 8px 16px;
      font-size: 16px;
      background: #f5f5f5;
      color: #333;
      border: 1px solid #ddd;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
    }
    .modal-zoom-controls button:hover {
      background: var(--accent);
      color: white;
      border-color: var(--accent);
    }
    .modal-diagram-wrapper {
      overflow: auto;
      max-height: calc(95vh - 150px);
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 16px;
      background: white;
    }
    .modal-diagram {
      transform-origin: top left;
      transition: transform 0.2s ease;
    }
    
    .toolbar {
      display: flex; gap: 8px; margin-left: auto;
    }
    button, .btn {
      cursor: pointer;
      border: 1px solid var(--border);
      background: var(--card);
      color: var(--text);
      border-radius: 10px;
      padding: 6px 10px;
      font-weight: 600;
    }
    button:hover { border-color: var(--accent); }
    code.inline { background: #0008; padding: 2px 6px; border-radius: 6px; }
    footer { opacity: .7; text-align: center; padding: 24px; }
    .hint { color: var(--muted); font-size: 0.95em; }
  </style>
</head>
<body class="">
  <header>
    <h1>üöÄ –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏ —Ä–∞–±–æ—Ç—ã: API Gateway –∏ –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å—ã</h1>
    <div class="toolbar">
      <button id="themeToggle" title="–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å —Ç–µ–º—É">üåó –¢–µ–º–∞</button>
      <button id="rerender" title="–ü–µ—Ä–µ—Ä–∏—Å–æ–≤–∞—Ç—å –¥–∏–∞–≥—Ä–∞–º–º—ã">üîÑ –û–±–Ω–æ–≤–∏—Ç—å –¥–∏–∞–≥—Ä–∞–º–º—ã</button>
    </div>
  </header>
  <main>
    <nav>
      <strong>–ù–∞–≤–∏–≥–∞—Ü–∏—è</strong>
      <a href="#overview">–û–±–∑–æ—Ä –∏ —Å—Ö–µ–º–∞</a>
      <a href="#classes">–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –∫–ª–∞—Å—Å–æ–≤ (User Service)</a>
      <a href="#signup">–°—Ü–µ–Ω–∞—Ä–∏–π 1: –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</a>
      <a href="#login">–°—Ü–µ–Ω–∞—Ä–∏–π 2: –õ–æ–≥–∏–Ω</a>
      <a href="#protected">–°—Ü–µ–Ω–∞—Ä–∏–π 3: –î–æ—Å—Ç—É–ø –∫ –∑–∞—â–∏—â—ë–Ω–Ω—ã–º –¥–∞–Ω–Ω—ã–º</a>
      <a href="#payment">–°—Ü–µ–Ω–∞—Ä–∏–π 4: –ó–∞–ø–∏—Å—å –Ω–∞ –∫—É—Ä—Å + –æ–ø–ª–∞—Ç–∞</a>
      <a href="#gateway">–ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç API Gateway</a>
      <a href="#checklist">–ß–µ–∫–ª–∏—Å—Ç</a>
    </nav>
    <div>
      <section id="overview">
        <h2>–û–±—â–∏–π –æ–±–∑–æ—Ä</h2>
        <p>–í—Å–µ –≤–Ω–µ—à–Ω–∏–µ –∑–∞–ø—Ä–æ—Å—ã –ø—Ä–æ—Ö–æ–¥—è—Ç —á–µ—Ä–µ–∑ <strong>API Gateway</strong>, –∫–æ—Ç–æ—Ä—ã–π –ø—Ä–æ–≤–µ—Ä—è–µ—Ç JWT, –ø—Ä–∏–º–µ–Ω—è–µ—Ç –±–∞–∑–æ–≤—ã–µ –ø—Ä–∞–≤–∏–ª–∞ –¥–æ—Å—Ç—É–ø–∞ –∏ –º–∞—Ä—à—Ä—É—Ç–∏–∑–∏—Ä—É–µ—Ç –∑–∞–ø—Ä–æ—Å—ã –∫ –Ω—É–∂–Ω—ã–º –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å–∞–º. –ù–∏–∂–µ ‚Äî –æ–±—â–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω–∞—è —Å—Ö–µ–º–∞.</p>
        <div class="diagram-container" data-diagram-id="overview-diagram">
          <div class="diagram-expand-hint">üîç –ù–∞–∂–º–∏—Ç–µ –¥–ª—è —É–≤–µ–ª–∏—á–µ–Ω–∏—è</div>
          <div class="mermaid">
graph TD
  subgraph CLIENT
    A[Frontend React / Vue / Angular]
  end
  subgraph GATEWAY
    B[API Gateway<br/>Spring Cloud Gateway<br/>:8080]
  end
  subgraph SERVICES
    U[User Service<br/>:8081<br/>PostgreSQL users_db]
    C[Course Service<br/>:8082<br/>PostgreSQL courses_db]
    E[Enrollment Service<br/>:8083<br/>PostgreSQL enrollments_db]
    P[Payment Service<br/>:8084<br/>PostgreSQL payments_db]
    N[Notification Service<br/>:8085<br/>PostgreSQL notifications_db]
    A2[Analytics Service<br/>:8086<br/>PostgreSQL analytics_db]
  end
  A -->|HTTP + JWT Token| B
  B -->|–ú–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è + –≤–∞–ª–∏–¥–∞—Ü–∏—è —Ç–æ–∫–µ–Ω–∞| U
  B --> C
  B --> E
  B --> P
  B --> N
  B --> A2
  U -->|–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è / –õ–æ–≥–∏–Ω / JWT –≤—ã–¥–∞—á–∞| B
          </div>
        </div>
      </section>

      <section id="classes">
        <h2>–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –∫–ª–∞—Å—Å–æ–≤: –ø—Ä–∏–º–µ—Ä User Service</h2>
        <p class="hint">–ö–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä—ã –ø—Ä–∏–Ω–∏–º–∞—é—Ç HTTP-–∑–∞–ø—Ä–æ—Å—ã, —Å–µ—Ä–≤–∏—Å—ã —Å–æ–¥–µ—Ä–∂–∞—Ç –ª–æ–≥–∏–∫—É, —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏ —Ä–∞–±–æ—Ç–∞—é—Ç —Å –ë–î, —É—Ç–∏–ª–∏—Ç—ã –ø–æ–º–æ–≥–∞—é—Ç —Å –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å—é (JWT, –ø–∞—Ä–æ–ª–∏).</p>
        <div class="diagram-container" data-diagram-id="classes-diagram">
          <div class="diagram-expand-hint">üîç –ù–∞–∂–º–∏—Ç–µ –¥–ª—è —É–≤–µ–ª–∏—á–µ–Ω–∏—è</div>
          <div class="mermaid">
classDiagram
  class UserController {
    +register(dto)
    +login(dto)
    +refresh(token)
    +getProfile()
    +updateProfile(dto)
  }
  class AuthController {
    +login(dto)
    +refresh(token)
    +logout()
  }
  class UserService {
    +createUser(dto)
    +findByEmail(email)
    +getProfile(userId)
    +updateProfile(userId,dto)
    +assignRoles(userId,roles)
  }
  class AuthService {
    +authenticate(email,password)
    +issueTokens(user)
    +refreshTokens(refreshToken)
    +revoke(refreshToken)
  }
  class JwtProvider {
    +sign(claims,exp)
    +validate(jwt)
    +getPublicJwks()
  }
  class PasswordHasher {
    +hash(password)
    +verify(plain,hash)
  }
  class UserRepository {
    +save(user)
    +findByEmail(email)
    +findById(id)
  }

  UserController --> UserService
  UserController --> AuthService
  AuthController --> AuthService
  AuthService --> UserService
  AuthService --> JwtProvider
  UserService --> PasswordHasher
  UserService --> UserRepository
          </div>
        </div>
      </section>

      <section id="signup">
        <h2>–°—Ü–µ–Ω–∞—Ä–∏–π 1: –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</h2>
        <details open>
          <summary>–î–∏–∞–≥—Ä–∞–º–º–∞ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏</summary>
          <div class="diagram-container" data-diagram-id="signup-diagram">
            <div class="diagram-expand-hint">üîç –ù–∞–∂–º–∏—Ç–µ –¥–ª—è —É–≤–µ–ª–∏—á–µ–Ω–∏—è</div>
            <div class="mermaid">
sequenceDiagram
  autonumber
  participant F as Frontend
  participant G as API Gateway
  participant Uc as UserController
  participant Us as UserService
  participant Ph as PasswordHasher
  participant Ur as UserRepository
  participant As as AuthService
  participant J as JwtProvider
  participant N as Notification Service –æ–ø—Ü

  F->>G: POST /api/users/register (email, password, name)
  G->>Uc: –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è –≤ user-service
  Uc->>Us: createUser(dto)
  Us->>Ph: hash(password)
  Ph-->>Us: passwordHash
  Us->>Ur: save(user+hash)
  Ur-->>Us: saved user(id, roles=["student"])
  alt –ê–≤—Ç–æ–≤—Ö–æ–¥ –≤–∫–ª—é—á–µ–Ω
    Uc->>As: issueTokens(user)
    As->>J: sign({sub,roles,iss,aud,exp})
    J-->>As: JWT (access), refresh
    As-->>Uc: Tokens(access,refresh)
    Uc-->>G: 201 Created + tokens
  else –ë–µ–∑ –∞–≤—Ç–æ–≤—Ö–æ–¥–∞
    Uc-->>G: 201 Created (–±–µ–∑ —Ç–æ–∫–µ–Ω–æ–≤)
  end
  opt –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
    Uc->>N: POST /api/notifications/send (email, —à–∞–±–ª–æ–Ω Welcome)
    N-->>Uc: 202 Accepted
  end
  G-->>F: –û—Ç–≤–µ—Ç –∫–ª–∏–µ–Ω—Ç—É
            </div>
          </div>
        </details>
        <details>
          <summary>–ü–æ—è—Å–Ω–µ–Ω–∏–µ –ø–æ —à–∞–≥–∞–º –∏ –∫–ª–∞—Å—Å–∞–º</summary>
          <ol>
            <li><code class="inline">UserController.register</code> –≤–∞–ª–∏–¥–∏—Ä—É–µ—Ç –≤—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏ –≤—ã–∑—ã–≤–∞–µ—Ç <code class="inline">UserService.createUser</code>.</li>
            <li><code class="inline">UserService</code> —Ö–µ—à–∏—Ä—É–µ—Ç –ø–∞—Ä–æ–ª—å —á–µ—Ä–µ–∑ <code class="inline">PasswordHasher</code> –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —á–µ—Ä–µ–∑ <code class="inline">UserRepository</code> (—Ä–æ–ª—å –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é <em>student</em>).</li>
            <li>–ï—Å–ª–∏ –≤–∫–ª—é—á—ë–Ω ¬´–∞–≤—Ç–æ–≤—Ö–æ–¥¬ª, <code class="inline">AuthService.issueTokens</code> —Å–æ–∑–¥–∞—ë—Ç <em>access</em>/<em>refresh</em> —á–µ—Ä–µ–∑ <code class="inline">JwtProvider</code>.</li>
            <li>–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è welcome-–ø–∏—Å—å–º–æ —á–µ—Ä–µ–∑ Notification Service.</li>
          </ol>
        </details>
      </section>

      <section id="login">
        <h2>–°—Ü–µ–Ω–∞—Ä–∏–π 2: –õ–æ–≥–∏–Ω (–∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è)</h2>
        <details open>
          <summary>–î–∏–∞–≥—Ä–∞–º–º–∞ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏</summary>
          <div class="diagram-container" data-diagram-id="login-diagram">
            <div class="diagram-expand-hint">üîç –ù–∞–∂–º–∏—Ç–µ –¥–ª—è —É–≤–µ–ª–∏—á–µ–Ω–∏—è</div>
            <div class="mermaid">
sequenceDiagram
  autonumber
  participant F as Frontend
  participant G as API Gateway
  participant Ac as AuthController
  participant As as AuthService
  participant Us as UserService
  participant Ph as PasswordHasher
  participant J as JwtProvider

  F->>G: POST /api/users/login (email, password)
  G->>Ac: –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è –≤ user-service
  Ac->>As: authenticate(email,password)
  As->>Us: findByEmail(email)
  Us-->>As: user + passwordHash + roles
  As->>Ph: verify(password, hash)
  Ph-->>As: ok
  As->>J: sign({sub,roles,iss,aud,exp})
  J-->>As: JWT access + refresh
  As-->>Ac: Tokens(access, refresh)
  Ac-->>G: 200 OK + tokens
  G-->>F: 200 OK + tokens
            </div>
          </div>
        </details>
        <details>
          <summary>–ü–æ—è—Å–Ω–µ–Ω–∏–µ –ø–æ —à–∞–≥–∞–º –∏ –∫–ª–∞—Å—Å–∞–º</summary>
          <p><code class="inline">AuthService.authenticate</code> –Ω–∞—Ö–æ–¥–∏—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, —Å–≤–µ—Ä—è–µ—Ç –ø–∞—Ä–æ–ª—å –∏ –ø—Ä–∏ —É—Å–ø–µ—Ö–µ –≤—ã–¥–∞—ë—Ç —Ç–æ–∫–µ–Ω—ã —á–µ—Ä–µ–∑ <code class="inline">JwtProvider</code>. Gateway –∑–¥–µ—Å—å –Ω–∏—á–µ–≥–æ –Ω–µ –ø–æ–¥–ø–∏—Å—ã–≤–∞–µ—Ç ‚Äî –æ–Ω –ª–∏—à—å –ø—Ä–æ–∫—Å–∏—Ä—É–µ—Ç –∑–∞–ø—Ä–æ—Å –∏ –ø–æ—Ç–æ–º –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —Ç–æ–∫–µ–Ω—ã –Ω–∞ –ø–æ—Å–ª–µ–¥—É—é—â–∏—Ö –∑–∞–ø—Ä–æ—Å–∞—Ö.</p>
        </details>
      </section>

      <section id="protected">
        <h2>–°—Ü–µ–Ω–∞—Ä–∏–π 3: –î–æ—Å—Ç—É–ø –∫ –∑–∞—â–∏—â—ë–Ω–Ω—ã–º –¥–∞–Ω–Ω—ã–º (–ø—Ä–∏–º–µ—Ä: —Å–≤–æ–∏ –∑–∞—á–∏—Å–ª–µ–Ω–∏—è)</h2>
        <details open>
          <summary>–î–∏–∞–≥—Ä–∞–º–º–∞ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏</summary>
          <div class="diagram-container" data-diagram-id="protected-diagram">
            <div class="diagram-expand-hint">üîç –ù–∞–∂–º–∏—Ç–µ –¥–ª—è —É–≤–µ–ª–∏—á–µ–Ω–∏—è</div>
            <div class="mermaid">
sequenceDiagram
  autonumber
  participant F as Frontend
  participant G as API Gateway (JwtAuthFilter, RateLimit, CORS)
  participant EnC as EnrollmentController
  participant EnS as EnrollmentService
  participant EnR as EnrollmentRepository

  F->>G: GET /api/enrollments/user/{userId} (Authorization: Bearer JWT)
  G->>G: JwtAuthFilter.validate(jwt: iss,aud,exp,signature)
  G->>G: Coarse auth: –¥–æ—Å—Ç—É–ø–µ–Ω –ª–∏ —Ä–æ—É—Ç —Ä–æ–ª–∏?
  G->>EnC: –ø—Ä–æ–∫—Å–∏—Ä—É–µ–º –∑–∞–ø—Ä–æ—Å –≤ enrollment-service
  EnC->>EnS: getByUser(userId, claims.sub, claims.roles)
  alt –í–ª–∞–¥–µ–ª–µ—Ü –∏–ª–∏ admin
    EnS->>EnR: findByUserId(userId)
    EnR-->>EnS: —Å–ø–∏—Å–æ–∫ –∑–∞—á–∏—Å–ª–µ–Ω–∏–π
    EnS-->>EnC: ok
    EnC-->>G: 200 + data
  else –ß—É–∂–∏–µ –¥–∞–Ω–Ω—ã–µ
    EnS-->>EnC: 403 Forbidden
    EnC-->>G: 403
  end
  G-->>F: –û—Ç–≤–µ—Ç
            </div>
          </div>
        </details>
        <details>
          <summary>–ü–æ—è—Å–Ω–µ–Ω–∏–µ –ø–æ —à–∞–≥–∞–º –∏ –∫–ª–∞—Å—Å–∞–º</summary>
          <ul>
            <li>Gateway –ø—Ä–æ–≤–µ—Ä—è–µ—Ç JWT –∏ –±–∞–∑–æ–≤—ã–µ –ø—Ä–∞–≤–∞ –Ω–∞ –º–∞—Ä—à—Ä—É—Ç (coarse-grained).</li>
            <li>–í —Å–µ—Ä–≤–∏—Å–µ –∏–¥—ë—Ç ¬´—Ç–æ–Ω–∫–∞—è¬ª –ø—Ä–æ–≤–µ—Ä–∫–∞: <code class="inline">claims.sub == {userId}</code> –∏–ª–∏ —Ä–æ–ª—å <em>admin</em>; –∑–∞—Ç–µ–º –≤—ã–±–æ—Ä–∫–∞ –∏–∑ –ë–î.</li>
          </ul>
        </details>
      </section>

      <section id="payment">
        <h2>–°—Ü–µ–Ω–∞—Ä–∏–π 4: –ó–∞–ø–∏—Å—å –Ω–∞ –∫—É—Ä—Å + –æ–ø–ª–∞—Ç–∞ + —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ</h2>
        <details open>
          <summary>–î–∏–∞–≥—Ä–∞–º–º–∞ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏</summary>
          <div class="diagram-container" data-diagram-id="payment-diagram">
            <div class="diagram-expand-hint">üîç –ù–∞–∂–º–∏—Ç–µ –¥–ª—è —É–≤–µ–ª–∏—á–µ–Ω–∏—è</div>
            <div class="mermaid">
sequenceDiagram
  autonumber
  participant F as Frontend
  participant G as API Gateway (JWT check)
  participant P as Payment Service
  participant PSP as –í–Ω–µ—à–Ω–∏–π –ü—Ä–æ–≤–∞–π–¥–µ—Ä –ü–ª–∞—Ç–µ–∂–µ–π
  participant En as Enrollment Service
  participant N as Notification Service
  participant A as Analytics Service

  F->>G: POST /api/payments/process {courseId, price} (Bearer JWT)
  G->>P: –ø—Ä–æ–∫—Å–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ payment-service
  P->>PSP: –°–æ–∑–¥–∞—Ç—å –ø–ª–∞—Ç–µ–∂ (redirect/3DS/webhook)
  PSP-->>P: Success (txnId)
  P-->>G: 200 OK + txnId

  Note over F,G: –ö–ª–∏–µ–Ω—Ç –º–æ–∂–µ—Ç –ø–æ–ª—É—á–∏—Ç—å 200, –∞ –∑–∞—á–∏—Å–ª–µ–Ω–∏–µ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –ø–æ webhook-–µ

  PSP-->>P: Webhook: payment.succeeded (txnId, userId, courseId)
  P->>En: POST /api/enrollments {userId, courseId, txnId}
  En-->>P: 201 Created
  P->>N: POST /api/notifications/send (email, "–í—ã –∑–∞–ø–∏—Å–∞–Ω—ã –Ω–∞ –∫—É—Ä—Å")
  N-->>P: 202 Accepted
  P->>A: POST /api/analytics/revenue {txnId, amount, courseId}
  A-->>P: 202 Accepted
            </div>
          </div>
        </details>
        <details>
          <summary>–ü–æ—è—Å–Ω–µ–Ω–∏–µ –ø–æ —à–∞–≥–∞–º –∏ –∫–ª–∞—Å—Å–∞–º</summary>
          <p>Payment Service –∏–Ω–∏—Ü–∏–∏—Ä—É–µ—Ç –ø–ª–∞—Ç—ë–∂ —É –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞ (PSP). –ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ webhook-–∞ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –ø–æ–¥–ø–∏—Å—å, —Å–æ–∑–¥–∞—ë—Ç –∑–∞—á–∏—Å–ª–µ–Ω–∏–µ –≤ Enrollment, –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∏ –º–µ—Ç—Ä–∏–∫—É –≤ Analytics.</p>
        </details>
      </section>

      <section id="gateway">
        <h2>–ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç API Gateway (—Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏)</h2>
        <ul>
          <li><strong>JwtAuthFilter</strong>: –≤–∞–ª–∏–¥–∞—Ü–∏—è –ø–æ–¥–ø–∏—Å–∏ –∏ –ø–æ–ª–µ–π —Ç–æ–∫–µ–Ω–∞ (<code class="inline">exp</code>, <code class="inline">iss</code>, <code class="inline">aud</code>), –∑–∞–≥—Ä—É–∑–∫–∞ JWK –∏–∑ <code class="inline">/.well-known/jwks.json</code> user-service.</li>
          <li><strong>Coarse-grained –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è</strong>: –ø—Ä–æ—Å—Ç—ã–µ –ø—Ä–∞–≤–∏–ª–∞ ¬´–∫–∞–∫–∞—è —Ä–æ–ª—å –º–æ–∂–µ—Ç –Ω–∞ –∫–∞–∫–æ–π –º–∞—Ä—à—Ä—É—Ç/–º–µ—Ç–æ–¥¬ª.</li>
          <li><strong>–ü—Ä–æ–∫—Å–∏—Ä–æ–≤–∞–Ω–∏–µ</strong>: –ª–∏–±–æ –ø—Ä–æ–∫–∏–¥—ã–≤–∞–µ–º –∏—Å—Ö–æ–¥–Ω—ã–π <code class="inline">Authorization: Bearer</code>, –ª–∏–±–æ –∑–∞–º–µ–Ω—è–µ–º –Ω–∞ –ø–æ–¥–ø–∏—Å–∞–Ω–Ω—ã–µ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ –∑–∞–≥–æ–ª–æ–≤–∫–∏ <code class="inline">X-Auth-*</code> —Å TTL.</li>
          <li><strong>–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –∑–∞—â–∏—Ç–∞</strong>: Rate limiting –¥–ª—è —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã—Ö —ç–Ω–¥–ø–æ–∏–Ω—Ç–æ–≤, CORS, –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ/—Ç—Ä–µ–π—Å–∏–Ω–≥, —É–¥–∞–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö <code class="inline">X-User-*</code>.</li>
        </ul>
      </section>

      <section id="checklist">
        <h2>–ú–∏–Ω–∏-—á–µ–∫–ª–∏—Å—Ç</h2>
        <ul>
          <li>Gateway –ø—Ä–æ–≤–µ—Ä—è–µ—Ç JWT –∏ –æ—Ç—Å–µ–∫–∞–µ—Ç –¥–æ—Å—Ç—É–ø –ø–æ –º–∞—Ä—à—Ä—É—Ç–∞–º.</li>
          <li>–°–µ—Ä–≤–∏—Å –¥–µ–ª–∞–µ—Ç —Ç–æ–Ω–∫—É—é –ø—Ä–æ–≤–µ—Ä–∫—É –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º –¥–∞–Ω–Ω—ã–º.</li>
          <li>–í–Ω–µ—à–Ω–∏–π –º–∏—Ä –Ω–µ –≤–∏–¥–∏—Ç –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ —Å–µ—Ä–≤–∏—Å—ã (—Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ Gateway); mTLS –≤–Ω—É—Ç—Ä–∏.</li>
          <li>–¢–æ–∫–µ–Ω—ã –∂–∏–≤—É—Ç 5‚Äî15 –º–∏–Ω—É—Ç; refresh ‚Äî —á–µ—Ä–µ–∑ user-service.</li>
          <li>–õ–æ–≥–∏ –∏ —Ç—Ä–∞—Å—Å–∏—Ä–æ–≤–∫–∞ –ø–æ <code class="inline">X-Request-Id</code>.</li>
        </ul>
      </section>
      <footer class="hint">Mermaid-–¥–∏–∞–≥—Ä–∞–º–º—ã –º–æ–∂–Ω–æ —É–≤–µ–ª–∏—á–∏—Ç—å –Ω–∞–∂–∞—Ç–∏–µ–º –Ω–∞ –Ω–∏—Ö. –¢–µ–º–∞ –ø–µ—Ä–µ–∫–ª—é—á–∞–µ—Ç—Å—è –≤ —à–∞–ø–∫–µ.</footer>
    </div>
  </main>

  <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –¥–∏–∞–≥—Ä–∞–º–º -->
  <div class="modal" id="diagramModal">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title" id="modalTitle">–î–∏–∞–≥—Ä–∞–º–º–∞</div>
        <button class="modal-close" id="modalClose">‚úï –ó–∞–∫—Ä—ã—Ç—å</button>
      </div>
      <div class="modal-zoom-controls">
        <button data-zoom="out">‚ûñ –£–º–µ–Ω—å—à–∏—Ç—å</button>
        <button data-zoom="reset">‚ö´ –°–±—Ä–æ—Å–∏—Ç—å</button>
        <button data-zoom="in">‚ûï –£–≤–µ–ª–∏—á–∏—Ç—å</button>
      </div>
      <div class="modal-diagram-wrapper">
        <div class="modal-diagram" id="modalDiagram"></div>
      </div>
    </div>
  </div>

  <!-- Mermaid -->
  <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
  <script>
    // –¢–µ–º–∞
    const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
    const root = document.body;
    let theme = localStorage.getItem('theme') || (prefersDark ? 'dark' : 'light');
    
    function applyTheme(t) {
      if (t === 'light') root.classList.add('light');
      else root.classList.remove('light');
      if (window.mermaid) {
        window.mermaid.initialize({ startOnLoad: false, theme: t === 'light' ? 'default' : 'dark' });
        window.mermaid.run({});
      }
      localStorage.setItem('theme', t);
    }
    applyTheme(theme);

    document.getElementById('themeToggle').addEventListener('click', () => {
      theme = (theme === 'light') ? 'dark' : 'light';
      applyTheme(theme);
    });
    
    document.getElementById('rerender').addEventListener('click', () => {
      if (window.mermaid) window.mermaid.run({});
    });

    if (window.mermaid) {
      window.mermaid.initialize({ startOnLoad: true, theme: theme === 'light' ? 'default' : 'dark' });
    }

    // –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –¥–∏–∞–≥—Ä–∞–º–º
    const modal = document.getElementById('diagramModal');
    const modalDiagram = document.getElementById('modalDiagram');
    const modalTitle = document.getElementById('modalTitle');
    const modalClose = document.getElementById('modalClose');
    let currentScale = 1;

    // –û—Ç–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
    document.addEventListener('click', (e) => {
      const container = e.target.closest('.diagram-container');
      if (!container) return;
      
      const diagramId = container.dataset.diagramId;
      const mermaidContent = container.querySelector('.mermaid');
      if (!mermaidContent) return;
      
      // –ö–æ–ø–∏—Ä—É–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –¥–∏–∞–≥—Ä–∞–º–º—ã
      modalDiagram.innerHTML = mermaidContent.innerHTML;
      modalDiagram.className = 'modal-diagram mermaid';
      
      // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫
      const section = container.closest('section');
      const sectionTitle = section ? section.querySelector('h2')?.textContent : '–î–∏–∞–≥—Ä–∞–º–º–∞';
      modalTitle.textContent = sectionTitle;
      
      // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –º–∞—Å—à—Ç–∞–±
      currentScale = 1;
      modalDiagram.style.transform = 'scale(1)';
      
      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
      modal.classList.add('active');
      
      // –†–µ–Ω–¥–µ—Ä–∏–º –¥–∏–∞–≥—Ä–∞–º–º—É –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ
      if (window.mermaid) {
        window.mermaid.run({ nodes: [modalDiagram] });
      }
    });

    // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
    modalClose.addEventListener('click', () => {
      modal.classList.remove('active');
    });

    // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ –∫–ª–∏–∫—É –≤–Ω–µ –∫–æ–Ω—Ç–µ–Ω—Ç–∞
    modal.addEventListener('click', (e) => {
      if (e.target === modal) {
        modal.classList.remove('active');
      }
    });

    // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ Escape
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && modal.classList.contains('active')) {
        modal.classList.remove('active');
      }
    });

    // –ó—É–º-–∫–æ–Ω—Ç—Ä–æ–ª—ã –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ
    document.querySelector('.modal-zoom-controls').addEventListener('click', (e) => {
      const btn = e.target.closest('button[data-zoom]');
      if (!btn) return;
      
      const action = btn.dataset.zoom;
      if (action === 'in') currentScale = Math.min(currentScale + 0.25, 3);
      if (action === 'out') currentScale = Math.max(currentScale - 0.25, 0.5);
      if (action === 'reset') currentScale = 1;
      
      modalDiagram.style.transform = `scale(${currentScale})`;
    });
  </script>
</body>
</html>