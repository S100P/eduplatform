<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>–ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏: API Gateway –∏ –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å—ã (Zoomable, Fit-to-Modal, Fixed)</title>
  <style>
    :root {
      --bg: #0b1020;
      --card: #101632;
      --text: #e8ecff;
      --muted: #a7b0d6;
      --accent: #7aa2ff;
      --border: #223059;
      --backdrop: rgba(0,0,0,.65);
    }
    .light {
      --bg: #f7f8ff;
      --card: #ffffff;
      --text: #0c1535;
      --muted: #516089;
      --accent: #3857ff;
      --border: #e7ebff;
      --backdrop: rgba(0,0,0,.35);
    }
    html, body { height: 100%; }
    body {
      margin: 0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      background: linear-gradient(180deg, var(--bg), #060a18 60%);
      color: var(--text);
    }
    header {
      position: sticky;
      top: 0;
      z-index: 10;
      backdrop-filter: blur(8px);
      background: color-mix(in oklab, var(--bg) 85%, transparent);
      border-bottom: 1px solid var(--border);
      padding: 12px 16px;
      display: flex;
      align-items: center;
      gap: 12px;
    }
    h1 { font-size: 20px; margin: 0; }
    main {
      max-width: 1080px;
      margin: 24px auto;
      padding: 0 16px 64px;
      display: grid;
      grid-template-columns: 280px 1fr;
      gap: 16px;
    }
    nav {
      position: sticky; top: 64px;
      align-self: start;
      border: 1px solid var(--border);
      background: var(--card);
      border-radius: 16px;
      padding: 12px;
    }
    nav a {
      display: block;
      padding: 8px 10px;
      margin: 2px 0;
      color: var(--text);
      text-decoration: none;
      border-radius: 10px;
    }
    nav a:hover { background: color-mix(in oklab, var(--card) 80%, var(--accent)); }
    section {
      border: 1px solid var(--border);
      background: var(--card);
      border-radius: 16px;
      padding: 16px 16px 8px;
      margin-bottom: 16px;
    }
    h2 { margin-top: 0; }
    details {
      border: 1px dashed var(--border);
      border-radius: 12px;
      padding: 12px 12px;
      margin: 8px 0 16px;
      background: color-mix(in oklab, var(--card) 90%, #000);
    }
    details[open] { background: color-mix(in oklab, var(--card) 80%, #000); }
    summary { cursor: pointer; font-weight: 600; color: var(--accent); list-style: none; }
    summary::-webkit-details-marker { display: none; }
    .mermaid-wrapper {
      border: 1px solid var(--border);
      border-radius: 12px;
      background: #fff;
      color: #000;
      overflow: auto;
      position: relative;
      padding: 8px;
      margin-top: 8px;
    }
    .mermaid-toolbar {
      position: absolute;
      top: 8px;
      right: 8px;
      display: flex;
      gap: 6px;
      z-index: 2;
    }
    .mermaid-toolbar button {
      cursor: pointer;
      border: 1px solid #e5e7eb;
      background: #ffffff;
      color: #111827;
      border-radius: 8px;
      padding: 4px 8px;
      font-weight: 600;
      box-shadow: 0 1px 2px rgba(0,0,0,.08);
    }
    .mermaid-toolbar button:hover { border-color: #c7cbd5; }
    .mermaid { min-height: 80px; }

    /* Modal zoom */
    .modal {
      position: fixed;
      inset: 0;
      display: none;
      place-items: center;
      background: var(--backdrop);
      z-index: 50;
      padding: 24px;
    }
    .modal.open { display: grid; }
    .modal-card {
      width: min(1600px, 96vw);
      height: min(92vh, 1000px);
      background: #fff;
      color: #000;
      border-radius: 16px;
      box-shadow: 0 10px 40px rgba(0,0,0,.35);
      display: grid;
      grid-template-rows: auto 1fr;
      overflow: hidden;
    }
    .modal-header {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px;
      border-bottom: 1px solid #e5e7eb;
      background: #f8fafc;
    }
    .modal-title { font-weight: 700; }
    .modal-tools { margin-left: auto; display: flex; gap: 6px; }
    .modal-tools button {
      cursor: pointer;
      border: 1px solid #e5e7eb;
      background: #ffffff;
      color: #111827;
      border-radius: 8px;
      padding: 6px 10px;
      font-weight: 600;
      box-shadow: 0 1px 2px rgba(0,0,0,.08);
    }
    .modal-canvas {
      position: relative;
      background: #fff;
      overflow: hidden;
      cursor: grab;
    }
    .modal-canvas:active { cursor: grabbing; }
    .zoom-surface {
      transform-origin: 0 0;
      width: max-content;
      height: max-content;
      will-change: transform;
    }
    .zoom-surface svg { width: auto; height: auto; max-width: none; max-height: none; display: block; }
    footer { opacity: .7; text-align: center; padding: 24px; }
    .hint { color: var(--muted); font-size: 0.95em; }
  </style>
</head>
<body class="">
  <header>
    <h1>–ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏ —Ä–∞–±–æ—Ç—ã: API Gateway –∏ –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å—ã</h1>
    <div class="toolbar" style="display:flex;gap:8px;margin-left:auto;">
      <button id="themeToggle" title="–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å —Ç–µ–º—É">üåó –¢–µ–º–∞</button>
      <button id="rerender" title="–ü–µ—Ä–µ—Ä–∏—Å–æ–≤–∞—Ç—å –¥–∏–∞–≥—Ä–∞–º–º—ã">üîÑ –û–±–Ω–æ–≤–∏—Ç—å –¥–∏–∞–≥—Ä–∞–º–º—ã</button>
    </div>
  </header>
  <main>
    <nav>
      <strong>–ù–∞–≤–∏–≥–∞—Ü–∏—è</strong>
      <a href="#overview">–û–±–∑–æ—Ä –∏ —Å—Ö–µ–º–∞</a>
      <a href="#classes">–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –∫–ª–∞—Å—Å–æ–≤ (User Service)</a>
      <a href="#signup">–°—Ü–µ–Ω–∞—Ä–∏–π 1: –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</a>
      <a href="#login">–°—Ü–µ–Ω–∞—Ä–∏–π 2: –õ–æ–≥–∏–Ω</a>
      <a href="#protected">–°—Ü–µ–Ω–∞—Ä–∏–π 3: –î–æ—Å—Ç—É–ø –∫ –¥–∞–Ω–Ω—ã–º</a>
      <a href="#payment">–°—Ü–µ–Ω–∞—Ä–∏–π 4: –û–ø–ª–∞—Ç–∞</a>
      <a href="#gateway">API Gateway</a>
      <a href="#checklist">–ß–µ–∫–ª–∏—Å—Ç</a>
    </nav>
    <div>
      <section id="overview">
        <h2>–û–±—â–∏–π –æ–±–∑–æ—Ä</h2>
        <p>–í—Å–µ –≤–Ω–µ—à–Ω–∏–µ –∑–∞–ø—Ä–æ—Å—ã –ø—Ä–æ—Ö–æ–¥—è—Ç —á–µ—Ä–µ–∑ <strong>API Gateway</strong>, –∫–æ—Ç–æ—Ä—ã–π –ø—Ä–æ–≤–µ—Ä—è–µ—Ç JWT, –ø—Ä–∏–º–µ–Ω—è–µ—Ç –±–∞–∑–æ–≤—ã–µ –ø—Ä–∞–≤–∏–ª–∞ –¥–æ—Å—Ç—É–ø–∞ –∏ –º–∞—Ä—à—Ä—É—Ç–∏–∑–∏—Ä—É–µ—Ç –∑–∞–ø—Ä–æ—Å—ã –∫ –Ω—É–∂–Ω—ã–º –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å–∞–º. –ù–∏–∂–µ ‚Äî –æ–±—â–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω–∞—è —Å—Ö–µ–º–∞.</p>
        <div class="mermaid-wrapper" data-title="–û–±—â–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞">
          <div class="mermaid-toolbar">
            <button class="zoom-open">üîç –£–≤–µ–ª–∏—á–∏—Ç—å</button>
          </div>
          <div class="mermaid">
graph TD
  subgraph CLIENT
    A[Frontend (React / Vue / Angular)]
  end
  subgraph GATEWAY
    B[API Gateway<br/>Spring Cloud Gateway<br/>:8080]
  end
  subgraph SERVICES
    U[User Service<br/>:8081<br/>PostgreSQL (users_db)]
    C[Course Service<br/>:8082<br/>PostgreSQL (courses_db)]
    E[Enrollment Service<br/>:8083<br/>PostgreSQL (enrollments_db)]
    P[Payment Service<br/>:8084<br/>PostgreSQL (payments_db)]
    N[Notification Service<br/>:8085<br/>PostgreSQL (notifications_db)]
    A2[Analytics Service<br/>:8086<br/>PostgreSQL (analytics_db)]
  end
  A -->|"HTTP + JWT Token"| B
  B -->|"–ú–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è + –≤–∞–ª–∏–¥–∞—Ü–∏—è —Ç–æ–∫–µ–Ω–∞"| U
  B --> C
  B --> E
  B --> P
  B --> N
  B --> A2
  U -->|"–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è / –õ–æ–≥–∏–Ω / JWT –≤—ã–¥–∞—á–∞"| B
          </div>
        </div>
      </section>

      <section id="classes">
        <h2>–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –∫–ª–∞—Å—Å–æ–≤: –ø—Ä–∏–º–µ—Ä User Service</h2>
        <p class="hint">–ö–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä—ã –ø—Ä–∏–Ω–∏–º–∞—é—Ç HTTP-–∑–∞–ø—Ä–æ—Å—ã, —Å–µ—Ä–≤–∏—Å—ã —Å–æ–¥–µ—Ä–∂–∞—Ç –ª–æ–≥–∏–∫—É, —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏ —Ä–∞–±–æ—Ç–∞—é—Ç —Å –ë–î, —É—Ç–∏–ª–∏—Ç—ã –ø–æ–º–æ–≥–∞—é—Ç —Å –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å—é (JWT, –ø–∞—Ä–æ–ª–∏).</p>
        <div class="mermaid-wrapper" data-title="–ö–ª–∞—Å—Å—ã User Service">
          <div class="mermaid-toolbar">
            <button class="zoom-open">üîç –£–≤–µ–ª–∏—á–∏—Ç—å</button>
          </div>
          <div class="mermaid">
classDiagram
  class UserController {
    +register(dto)
    +login(dto)
    +refresh(token)
    +getProfile()
    +updateProfile(dto)
  }
  class AuthController {
    +login(dto)
    +refresh(token)
    +logout()
  }
  class UserService {
    +createUser(dto)
    +findByEmail(email)
    +getProfile(userId)
    +updateProfile(userId,dto)
    +assignRoles(userId,roles)
  }
  class AuthService {
    +authenticate(email,password)
    +issueTokens(user)
    +refreshTokens(refreshToken)
    +revoke(refreshToken)
  }
  class JwtProvider {
    +sign(claims,exp)
    +validate(jwt)
    +getPublicJwks()
  }
  class PasswordHasher {
    +hash(password)
    +verify(plain,hash)
  }
  class UserRepository {
    +save(user)
    +findByEmail(email)
    +findById(id)
  }

  UserController --> UserService
  UserController --> AuthService
  AuthController --> AuthService
  AuthService --> UserService
  AuthService --> JwtProvider
  UserService --> PasswordHasher
  UserService --> UserRepository
          </div>
        </div>
      </section>

      <section id="signup">
        <h2>–°—Ü–µ–Ω–∞—Ä–∏–π 1: –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</h2>
        <details open>
          <summary>–î–∏–∞–≥—Ä–∞–º–º–∞ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏</summary>
          <div class="mermaid-wrapper" data-title="–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è">
            <div class="mermaid-toolbar">
              <button class="zoom-open">üîç –£–≤–µ–ª–∏—á–∏—Ç—å</button>
            </div>
            <div class="mermaid">
sequenceDiagram
  autonumber
  participant F as Frontend
  participant G as API Gateway
  participant Uc as UserController
  participant Us as UserService
  participant Ph as PasswordHasher
  participant Ur as UserRepository
  participant As as AuthService
  participant J as JwtProvider
  participant N as Notification Service (–æ–ø—Ü)

  F->>G: POST /api/users/register (email, password, name)
  G->>Uc: –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è –≤ user-service
  Uc->>Us: createUser(dto)
  Us->>Ph: hash(password)
  Ph-->>Us: passwordHash
  Us->>Ur: save(user+hash)
  Ur-->>Us: saved user(id, roles=["student"])
  alt –ê–≤—Ç–æ–≤—Ö–æ–¥ –≤–∫–ª—é—á–µ–Ω
    Uc->>As: issueTokens(user)
    As->>J: sign({sub,roles,iss,aud,exp})
    J-->>As: JWT (access), refresh
    As-->>Uc: Tokens(access,refresh)
    Uc-->>G: 201 Created + tokens
  else –ë–µ–∑ –∞–≤—Ç–æ–≤—Ö–æ–¥–∞
    Uc-->>G: 201 Created (–±–µ–∑ —Ç–æ–∫–µ–Ω–æ–≤)
  end
  opt –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
    Uc->>N: POST /api/notifications/send (email, —à–∞–±–ª–æ–Ω Welcome)
    N-->>Uc: 202 Accepted
  end
  G-->>F: –û—Ç–≤–µ—Ç –∫–ª–∏–µ–Ω—Ç—É
            </div>
          </div>
        </details>
      </section>

      <section id="login">
        <h2>–°—Ü–µ–Ω–∞—Ä–∏–π 2: –õ–æ–≥–∏–Ω (–∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è)</h2>
        <details open>
          <summary>–î–∏–∞–≥—Ä–∞–º–º–∞ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏</summary>
          <div class="mermaid-wrapper" data-title="–õ–æ–≥–∏–Ω –∏ –≤—ã–¥–∞—á–∞ —Ç–æ–∫–µ–Ω–æ–≤">
            <div class="mermaid-toolbar">
              <button class="zoom-open">üîç –£–≤–µ–ª–∏—á–∏—Ç—å</button>
            </div>
            <div class="mermaid">
sequenceDiagram
  autonumber
  participant F as Frontend
  participant G as API Gateway
  participant Ac as AuthController
  participant As as AuthService
  participant Us as UserService
  participant Ph as PasswordHasher
  participant J as JwtProvider

  F->>G: POST /api/users/login (email, password)
  G->>Ac: –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è –≤ user-service
  Ac->>As: authenticate(email,password)
  As->>Us: findByEmail(email)
  Us-->>As: user + passwordHash + roles
  As->>Ph: verify(password, hash)
  Ph-->>As: ok
  As->>J: sign({sub,roles,iss,aud,exp})
  J-->>As: JWT access + refresh
  As-->>Ac: Tokens(access, refresh)
  Ac-->>G: 200 OK + tokens
  G-->>F: 200 OK + tokens
            </div>
          </div>
        </details>
      </section>

      <section id="protected">
        <h2>–°—Ü–µ–Ω–∞—Ä–∏–π 3: –î–æ—Å—Ç—É–ø –∫ –∑–∞—â–∏—â—ë–Ω–Ω—ã–º –¥–∞–Ω–Ω—ã–º (–ø—Ä–∏–º–µ—Ä: —Å–≤–æ–∏ –∑–∞—á–∏—Å–ª–µ–Ω–∏—è)</h2>
        <details open>
          <summary>–î–∏–∞–≥—Ä–∞–º–º–∞ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏</summary>
          <div class="mermaid-wrapper" data-title="–î–æ—Å—Ç—É–ø –∫ –∑–∞—á–∏—Å–ª–µ–Ω–∏—è–º">
            <div class="mermaid-toolbar">
              <button class="zoom-open">üîç –£–≤–µ–ª–∏—á–∏—Ç—å</button>
            </div>
            <div class="mermaid">
sequenceDiagram
  autonumber
  participant F as Frontend
  participant G as API Gateway (JwtAuthFilter, RateLimit, CORS)
  participant EnC as EnrollmentController
  participant EnS as EnrollmentService
  participant EnR as EnrollmentRepository

  F->>G: GET /api/enrollments/user/{userId} (Authorization: Bearer JWT)
  G->>G: JwtAuthFilter.validate(jwt: iss,aud,exp,signature)
  G->>G: Coarse auth: –¥–æ—Å—Ç—É–ø–µ–Ω –ª–∏ —Ä–æ—É—Ç —Ä–æ–ª–∏?
  G->>EnC: –ø—Ä–æ–∫—Å–∏—Ä—É–µ–º –∑–∞–ø—Ä–æ—Å –≤ enrollment-service
  EnC->>EnS: getByUser(userId, claims.sub, claims.roles)
  alt –í–ª–∞–¥–µ–ª–µ—Ü –∏–ª–∏ admin
    EnS->>EnR: findByUserId(userId)
    EnR-->>EnS: —Å–ø–∏—Å–æ–∫ –∑–∞—á–∏—Å–ª–µ–Ω–∏–π
    EnS-->>EnC: ok
    EnC-->>G: 200 + data
  else –ß—É–∂–∏–µ –¥–∞–Ω–Ω—ã–µ
    EnS-->>EnC: 403 Forbidden
    EnC-->>G: 403
  end
  G-->>F: –û—Ç–≤–µ—Ç
            </div>
          </div>
        </details>
      </section>

      <section id="payment">
        <h2>–°—Ü–µ–Ω–∞—Ä–∏–π 4: –ó–∞–ø–∏—Å—å –Ω–∞ –∫—É—Ä—Å + –æ–ø–ª–∞—Ç–∞ + —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ</h2>
        <details open>
          <summary>–î–∏–∞–≥—Ä–∞–º–º–∞ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏</summary>
          <div class="mermaid-wrapper" data-title="–û–ø–ª–∞—Ç–∞ –∏ –∑–∞—á–∏—Å–ª–µ–Ω–∏–µ">
            <div class="mermaid-toolbar">
              <button class="zoom-open">üîç –£–≤–µ–ª–∏—á–∏—Ç—å</button>
            </div>
            <div class="mermaid">
sequenceDiagram
  autonumber
  participant F as Frontend
  participant G as API Gateway (JWT check)
  participant P as Payment Service
  participant PSP as –í–Ω–µ—à–Ω–∏–π –ü—Ä–æ–≤–∞–π–¥–µ—Ä –ü–ª–∞—Ç–µ–∂–µ–π
  participant En as Enrollment Service
  participant N as Notification Service
  participant A as Analytics Service

  F->>G: POST /api/payments/process {courseId, price} (Bearer JWT)
  G->>P: –ø—Ä–æ–∫—Å–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ payment-service
  P->>PSP: –°–æ–∑–¥–∞—Ç—å –ø–ª–∞—Ç–µ–∂ (redirect/3DS/webhook)
  PSP-->>P: Success (txnId)
  P-->>G: 200 OK + txnId

  Note over F,G: –ö–ª–∏–µ–Ω—Ç –º–æ–∂–µ—Ç –ø–æ–ª—É—á–∏—Ç—å 200, –∞ –∑–∞—á–∏—Å–ª–µ–Ω–∏–µ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –ø–æ webhook-–µ

  PSP-->>P: Webhook: payment.succeeded (txnId, userId, courseId)
  P->>En: POST /api/enrollments {userId, courseId, txnId}
  En-->>P: 201 Created
  P->>N: POST /api/notifications/send (email, "–í—ã –∑–∞–ø–∏—Å–∞–Ω—ã –Ω–∞ –∫—É—Ä—Å")
  N-->>P: 202 Accepted
  P->>A: POST /api/analytics/revenue {txnId, amount, courseId}
  A-->>P: 202 Accepted
            </div>
          </div>
        </details>
      </section>

      <section id="gateway">
        <h2>–ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç API Gateway (—Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏)</h2>
        <ul>
          <li><strong>JwtAuthFilter</strong>: –≤–∞–ª–∏–¥–∞—Ü–∏—è –ø–æ–¥–ø–∏—Å–∏ –∏ –ø–æ–ª–µ–π —Ç–æ–∫–µ–Ω–∞ (<code class="inline">exp</code>, <code class="inline">iss</code>, <code class="inline">aud</code>), –∑–∞–≥—Ä—É–∑–∫–∞ JWK –∏–∑ <code class="inline">/.well-known/jwks.json</code> user-service.</li>
          <li><strong>Coarse‚Äëgrained –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è</strong>: –ø—Ä–æ—Å—Ç—ã–µ –ø—Ä–∞–≤–∏–ª–∞ ¬´–∫–∞–∫–∞—è —Ä–æ–ª—å –º–æ–∂–µ—Ç –Ω–∞ –∫–∞–∫–æ–π –º–∞—Ä—à—Ä—É—Ç/–º–µ—Ç–æ–¥¬ª.</li>
          <li><strong>–ü—Ä–æ–∫—Å–∏—Ä–æ–≤–∞–Ω–∏–µ</strong>: –ª–∏–±–æ –ø—Ä–æ–∫–∏–¥—ã–≤–∞–µ–º –∏—Å—Ö–æ–¥–Ω—ã–π <code class="inline">Authorization: Bearer</code>, –ª–∏–±–æ –∑–∞–º–µ–Ω—è–µ–º –Ω–∞ –ø–æ–¥–ø–∏—Å–∞–Ω–Ω—ã–µ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ –∑–∞–≥–æ–ª–æ–≤–∫–∏ <code class="inline">X-Auth-*</code> —Å TTL.</li>
          <li><strong>–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –∑–∞—â–∏—Ç–∞</strong>: Rate limiting –¥–ª—è —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã—Ö —ç–Ω–¥–ø–æ–∏–Ω—Ç–æ–≤, CORS, –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ/—Ç—Ä–µ–π—Å–∏–Ω–≥, —É–¥–∞–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö <code class="inline">X-User-*</code>.</li>
        </ul>
      </section>

      <section id="checklist">
        <h2>–ú–∏–Ω–∏‚Äë—á–µ–∫–ª–∏—Å—Ç</h2>
        <ul>
          <li>Gateway –ø—Ä–æ–≤–µ—Ä—è–µ—Ç JWT –∏ –æ—Ç—Å–µ–∫–∞–µ—Ç –¥–æ—Å—Ç—É–ø –ø–æ –º–∞—Ä—à—Ä—É—Ç–∞–º.</li>
          <li>–°–µ—Ä–≤–∏—Å –¥–µ–ª–∞–µ—Ç —Ç–æ–Ω–∫—É—é –ø—Ä–æ–≤–µ—Ä–∫—É –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º –¥–∞–Ω–Ω—ã–º.</li>
          <li>–í–Ω–µ—à–Ω–∏–π –º–∏—Ä –Ω–µ –≤–∏–¥–∏—Ç –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ —Å–µ—Ä–≤–∏—Å—ã (—Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ Gateway); mTLS –≤–Ω—É—Ç—Ä–∏.</li>
          <li>–¢–æ–∫–µ–Ω—ã –∂–∏–≤—É—Ç 5‚Äì15 –º–∏–Ω—É—Ç; refresh ‚Äî —á–µ—Ä–µ–∑ user‚Äëservice.</li>
          <li>–õ–æ–≥–∏ –∏ —Ç—Ä–∞—Å—Å–∏—Ä–æ–≤–∫–∞ –ø–æ <code class="inline">X-Request-Id</code>.</li>
        </ul>
      </section>
      <footer class="hint">–ö–ª–∏–∫ –ø–æ ¬´–£–≤–µ–ª–∏—á–∏—Ç—å¬ª –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç –º–æ–¥–∞–ª. –î–∏–∞–≥—Ä–∞–º–º–∞ —Ä–µ–Ω–¥–µ—Ä–∏—Ç—Å—è –∑–∞–Ω–æ–≤–æ –∫–∞–∫ SVG, –ø–æ–ª—É—á–∞–µ—Ç viewBox –∏ <strong>–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ—Ç—Å—è –ø–æ–¥ –æ–∫–Ω–æ</strong>. –î–∞–ª—å—à–µ –º–æ–∂–Ω–æ –∑—É–º–∏—Ç—å –±–µ–∑ –ø–æ—Ç–µ—Ä–∏ –∫–∞—á–µ—Å—Ç–≤–∞.</footer>
    </div>
  </main>

  <!-- Modal Zoom -->
  <div class="modal" id="zoomModal" aria-hidden="true">
    <div class="modal-card" role="dialog" aria-modal="true" aria-label="–£–≤–µ–ª–∏—á–µ–Ω–Ω–∞—è –¥–∏–∞–≥—Ä–∞–º–º–∞">
      <div class="modal-header">
        <div class="modal-title" id="zoomTitle">–î–∏–∞–≥—Ä–∞–º–º–∞</div>
        <div class="modal-tools">
          <button id="fitBtn" title="–ü–æ–¥–æ–≥–Ω–∞—Ç—å –∫ –æ–∫–Ω—É">‚§¢ Fit</button>
          <button id="zoomOutBtn">üîé ‚àí</button>
          <button id="zoomInBtn">üîç +</button>
          <button id="zoomResetBtn">‚§¢ –°–±—Ä–æ—Å</button>
          <button id="zoomCloseBtn">‚úï –ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
      </div>
      <div class="modal-canvas" id="zoomCanvas">
        <div class="zoom-surface" id="zoomSurface"></div>
      </div>
    </div>
  </div>

  <!-- Mermaid -->
  <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
  <script>
    const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
    const root = document.body;
    let theme = localStorage.getItem('theme') || (prefersDark ? 'dark' : 'light');

    function captureGraphDefs() {
      document.querySelectorAll('.mermaid-wrapper .mermaid').forEach((el) => {
        if (!el.dataset.graph) {
          el.dataset.graph = el.textContent.trim();
        }
      });
    }

    function applyTheme(t) {
      if (t === 'light') root.classList.add('light');
      else root.classList.remove('light');
      if (window.mermaid) {
        window.mermaid.initialize({ startOnLoad: false, theme: t === 'light' ? 'default' : 'dark' });
        window.mermaid.run({});
      }
      localStorage.setItem('theme', t);
    }

    captureGraphDefs();
    applyTheme(theme);
    document.getElementById('themeToggle').addEventListener('click', () => {
      theme = (theme === 'light') ? 'dark' : 'light';
      applyTheme(theme);
    });
    document.getElementById('rerender').addEventListener('click', () => {
      if (window.mermaid) window.mermaid.run({});
    });
    if (window.mermaid) {
      window.mermaid.initialize({ startOnLoad: true, theme: theme === 'light' ? 'default' : 'dark' });
    }

    // ===== Modal zoom logic (vector, fit to modal) =====
    const modal = document.getElementById('zoomModal');
    const zoomSurface = document.getElementById('zoomSurface');
    const zoomCanvas = document.getElementById('zoomCanvas');
    const zoomTitle = document.getElementById('zoomTitle');
    const zoomInBtn = document.getElementById('zoomInBtn');
    const zoomOutBtn = document.getElementById('zoomOutBtn');
    const zoomResetBtn = document.getElementById('zoomResetBtn');
    const zoomCloseBtn = document.getElementById('zoomCloseBtn');
    const fitBtn = document.getElementById('fitBtn');

    let scale = 1;
    let offsetX = 0;
    let offsetY = 0;
    let isPanning = false;
    let startX = 0;
    let startY = 0;
    let currentSVG = null;
    let currentGraph = '';
    let currentId = 0;

    function applyTransform() {
      zoomSurface.style.transform = `translate(${offsetX}px, ${offsetY}px) scale(${scale})`;
    }

    function fitToCanvas(pad = 0.92) {
      if (!currentSVG) return;
      const viewBox = currentSVG.getAttribute('viewBox');
      let w, h;
      if (viewBox) {
        const parts = viewBox.split(' ').map(Number);
        w = parts[2]; h = parts[3];
      } else {
        const bb = currentSVG.getBBox();
        w = bb.width; h = bb.height;
        currentSVG.setAttribute('viewBox', `0 0 ${w} ${h}`);
      }
      const cw = zoomCanvas.clientWidth;
      const ch = zoomCanvas.clientHeight;
      scale = Math.max(0.1, Math.min(cw / w, ch / h) * pad);
      offsetX = (cw - w * scale) / 2;
      offsetY = (ch - h * scale) / 2;
      applyTransform();
    }

    async function renderSVG(graphText) {
      currentId += 1;
      const id = 'zoom_' + currentId;
      const { svg } = await window.mermaid.render(id, graphText);
      const container = document.createElement('div');
      container.innerHTML = svg;
      const svgEl = container.querySelector('svg');
      svgEl.removeAttribute('width');
      svgEl.removeAttribute('height');
      svgEl.setAttribute('preserveAspectRatio', 'xMidYMid meet');
      return svgEl;
    }

    async function openZoom(wrapper) {
      zoomSurface.innerHTML = '';
      const source = wrapper.querySelector('.mermaid');
      const raw = source?.dataset.graph ?? source?.textContent ?? '';
      currentGraph = String(raw).trim();
      zoomTitle.textContent = wrapper.getAttribute('data-title') || '–î–∏–∞–≥—Ä–∞–º–º–∞';

      currentSVG = await renderSVG(currentGraph);
      zoomSurface.appendChild(currentSVG);

      if (!currentSVG.getAttribute('viewBox')) {
        const bb = currentSVG.getBBox();
        currentSVG.setAttribute('viewBox', `0 0 ${bb.width} ${bb.height}`);
      }

      scale = 1; offsetX = 0; offsetY = 0;
      modal.classList.add('open');
      modal.setAttribute('aria-hidden', 'false');

      requestAnimationFrame(() => fitToCanvas(0.95));
    }

    function closeZoom() {
      modal.classList.remove('open');
      modal.setAttribute('aria-hidden', 'true');
      currentSVG = null;
    }

    document.querySelectorAll('.zoom-open').forEach(btn => {
      btn.addEventListener('click', () => openZoom(btn.closest('.mermaid-wrapper')));
    });

    zoomInBtn.addEventListener('click', () => { scale = Math.min(scale * 1.2, 12); applyTransform(); });
    zoomOutBtn.addEventListener('click', () => { scale = Math.max(scale / 1.2, 0.1); applyTransform(); });
    zoomResetBtn.addEventListener('click', () => { scale = 1; offsetX = 0; offsetY = 0; applyTransform(); });
    fitBtn.addEventListener('click', () => fitToCanvas(0.96));

    zoomCloseBtn.addEventListener('click', closeZoom);
    modal.addEventListener('click', (e) => { if (e.target === modal) closeZoom(); });
    window.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') closeZoom();
      if (!modal.classList.contains('open')) return;
      if (e.key === '+' || e.key === '=') { scale = Math.min(scale * 1.2, 12); applyTransform(); }
      if (e.key === '-' || e.key === '_') { scale = Math.max(scale / 1.2, 0.1); applyTransform(); }
      if (e.key.toLowerCase() === 'r') { scale = 1; offsetX = 0; offsetY = 0; applyTransform(); }
      if (e.key.toLowerCase() === 'f') { fitToCanvas(0.96); }
    });

    // Panning
    zoomCanvas.addEventListener('mousedown', (e) => {
      if (!modal.classList.contains('open')) return;
      isPanning = true;
      startX = e.clientX - offsetX;
      startY = e.clientY - offsetY;
    });
    window.addEventListener('mousemove', (e) => {
      if (!isPanning) return;
      offsetX = e.clientX - startX;
      offsetY = e.clientY - startY;
      applyTransform();
    });
    window.addEventListener('mouseup', () => { isPanning = false; });

    // Wheel zoom with cursor focus point
    zoomCanvas.addEventListener('wheel', (e) => {
      if (!modal.classList.contains('open')) return;
      e.preventDefault();
      const delta = e.deltaY < 0 ? 1.1 : 0.9;
      const prevScale = scale;
      scale = Math.min(Math.max(scale * delta, 0.1), 12);

      const rect = zoomCanvas.getBoundingClientRect();
      const cx = e.clientX - rect.left;
      const cy = e.clientY - rect.top;
      offsetX = cx - (cx - offsetX) * (scale / prevScale);
      offsetY = cy - (cy - offsetY) * (scale / prevScale);
      applyTransform();
    }, { passive: false });

    // Re-fit on modal resize
    const ro = new ResizeObserver(() => { if (modal.classList.contains('open')) fitToCanvas(0.95); });
    ro.observe(zoomCanvas);
  </script>
</body>
</html>
